#include <stdlib.h>#include <stdio.h>#include "pixmap.h"#include "extractpl.h"Color header, header1 ;PixelMap map, iconmap ;char *clut ;int xsize, ysize ;void swapendian2 (short *s){  unsigned short tmp = (unsigned short)*s ;    *s = (tmp << 8) + (tmp >> 8) ;}void swapendian4 (long *s){  unsigned long tmp = (unsigned long)*s ;  *s = (tmp << 16) + (tmp >> 16) ;  swapendian2 ((short*)s) ;  swapendian2 ((short*)((short*)s+1)) ;}void display (const char *name){  PixelMap iconmap ;  long debimage ;  FILE *infile ;  long c ;  Pt dim ;    infile = fopen (name, "rb") ;  if (infile == NULL)    {      fprintf (stderr,"Can't open '%s'\n", name) ;      exit (1) ;    }  fread (&header, sizeof (header), 1, infile) ;    if (header.imlgc != 0)  {    clut = malloc (header.imlgc) ;    fread (clut, header.imlgc, 1, infile) ;  }    if (header.imsiz == 0)    header.imsiz = 1 ;    debimage = ftell (infile) ;    dim.x = xsize ;  dim.y = ysize ;  getpixelmap (&iconmap, dim,  header.imsiz == 4);    c = 0 ;  do  {    long pos ;    pos = c * xsize * ysize * header.imsiz / 8 ;    fseek (infile, debimage + pos, SEEK_SET) ;    fread (iconmap.data, xsize * ysize * header.imsiz / 8, 1 , infile) ;        copypixel2 (&iconmap, (Pt){0,0}, NULL, (Pt){0,0}, dim, MODELOAD, header.imsiz == 4);        c++ ;  }  while (getch () != 'A') ;      fclose (infile) ;}int main (int argc, char **argv){  Pt orig ;  Pt os = {0,0} ;  Pt dim ;  int ni ;  int err ;  long nbicons, nbicons1;  int i ;  int inlength, outlength ;  char *outbuffer, *pcbuffer ;  int color ;  int pc = 0 ;  int codeit = 1 ;     long position ;  long *index ;    FILE *outfile, *infile ;    int nbicx, nbicy, icx, icy ;    char name[100] ;  char outname[100] ;      if (!(argc == 5 || argc == 6))    {      fprintf (stderr, "usage: %s input output ysize xsize [-pc|-pcn]\n", argv[0]) ;      exit (1) ;    }      if (argc == 6)  {    if (strcmp (argv[5], "-pc") == 0)      pc = 1 ;          printf ("%d", strcmp (argv[5], "-pcn")) ;    getch () ;    if (strcmp (argv[5], "-pcn") == 0)    {      pc = 1 ;      codeit = 0 ;    }  }  strcpy (name, argv[1]) ;    infile = fopen (name, "rb") ;  if (infile == NULL)    {      fprintf (stderr,"Can't open '%s'\n", name) ;      exit (1) ;    }  fread (&header, sizeof (header), 1, infile) ;    if (header.imlgc != 0)  {    clut = malloc (header.imlgc) ;    fread (clut, header.imlgc, 1, infile) ;  }    color = (header.imtyp == 0x82) ;  strcpy (outname, argv[2]) ;  ysize = atoi (argv[3]) ;  xsize = atoi (argv[4]) ;    header1 = header ;  header1.imdlx = xsize ;    if (pc)    {      swapendian2 (&(header1.imdlx)) ;      swapendian2 (&header1.imdly) ;      swapendian4 (&header1.imnbb) ;      swapendian2 (&header1.imsiz) ;      swapendian2 (&header1.imcnt) ;      swapendian4 (&header1.imlgc) ;    }  outfile = fopen (outname, "wb") ;     if (outfile == NULL)    {      fprintf (stderr,"Can't open '%s'\n", name) ;      exit (1) ;    }  fwrite (&header1, sizeof (header), 1, outfile) ;    if (header.imlgc != 0)  {    fwrite (clut, header.imlgc, 1, outfile) ;  }      openmachine () ;  err = getimage (&map, name, color);  if (err != 0)    {      fprintf (stderr, "err = %x\n", err) ;      getch () ;      exit (0) ;    } ;  dim.x = xsize ;  dim.y = ysize ;  getpixelmap (&iconmap, dim, color);  orig.x = 0 ;  nbicx = map.dx / xsize ;  nbicy = map.dy / ysize ;  nbicons = nbicx * nbicy ;  inlength = iconmap.dxb * dim.y ;    outbuffer = malloc (inlength * 2) ;  pcbuffer = malloc (inlength * 2) ;  for (icy = 0 ; icy < nbicy ; icy++)  for (icx = 0 ; icx < nbicx ; icx++)  {    Pt imdim = dim ;    char *codebuffer ;    /* inutile: imdim.y = dim.y ; */        orig.y = icy * ysize ;    orig.x = icx * xsize ;    clrpixelmap (&iconmap) ;    copypixel2 (&map, orig, &iconmap, (Pt){0,0}, imdim, MODELOAD, color);    copypixel2 (&iconmap, (Pt){0,0}, NULL, (Pt){0,0}, imdim, MODELOAD, color);        if (pc)      {        extract_planes (iconmap.data, pcbuffer, inlength, color) ;        codebuffer = pcbuffer ;      }    else      codebuffer = iconmap.data ;          fwrite (codebuffer, inlength, 1, outfile) ;      }        header1 = header ;    if (header1.imsiz == 0)    header1.imsiz = 1 ;  header1.imdlx = xsize ;  header1.imdly = ysize * nbicons ;  header1.imcod = 0 ;  header1.imnbb = xsize * ysize * nbicons * header1.imsiz / 8 ;     if (pc)    {      swapendian2 (&(header1.imdlx)) ;      swapendian2 (&header1.imdly) ;      swapendian4 (&header1.imnbb) ;      swapendian2 (&header1.imsiz) ;      swapendian2 (&header1.imcnt) ;      swapendian4 (&header1.imlgc) ;    }  fseek (outfile, 0, SEEK_SET) ;  if (header1.imsiz == 1)    header1.imsiz = 0 ;  fwrite (&header1, sizeof (header), 1, outfile) ;        fclose (infile) ;  fclose (outfile) ;    display (outname) ;      return 0 ;}